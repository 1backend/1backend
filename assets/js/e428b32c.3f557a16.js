"use strict";(self.webpackChunksingulatron_api_docs=self.webpackChunksingulatron_api_docs||[]).push([[4830],{47956:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>t,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"built-in-services/user-svc","title":"User Svc","description":"The user service is at the heart of 1Backend, managing users, tokens, organizations, permissions and more. Each service and human on an 1Backend network has an account in the User Svc.","source":"@site/docs/built-in-services/user-svc.md","sourceDirName":"built-in-services","slug":"/built-in-services/user-svc","permalink":"/docs/built-in-services/user-svc","draft":false,"unlisted":false,"editUrl":"https://github.com/1backend/1backend/tree/main/docs-source/docs/built-in-services/user-svc.md","tags":[{"inline":true,"label":"user-svc","permalink":"/docs/tags/user-svc"},{"inline":true,"label":"permissions","permalink":"/docs/tags/permissions"},{"inline":true,"label":"roles","permalink":"/docs/tags/roles"},{"inline":true,"label":"authentication","permalink":"/docs/tags/authentication"},{"inline":true,"label":"authorization","permalink":"/docs/tags/authorization"},{"inline":true,"label":"service","permalink":"/docs/tags/service"},{"inline":true,"label":"service to service calls","permalink":"/docs/tags/service-to-service-calls"},{"inline":true,"label":"s2s calls","permalink":"/docs/tags/s-2-s-calls"}],"version":"current","sidebarPosition":10,"frontMatter":{"sidebar_position":10,"tags":["user-svc","permissions","roles","authentication","authorization","service","service to service calls","s2s calls"]},"sidebar":"tutorialSidebar","previous":{"title":"Built-in services","permalink":"/docs/category/built-in-services"},"next":{"title":"Secret Svc","permalink":"/docs/built-in-services/secret-svc"}}');var r=n(74848),o=n(28453);const t={sidebar_position:10,tags:["user-svc","permissions","roles","authentication","authorization","service","service to service calls","s2s calls"]},a="User Svc",c={},l=[{value:"Glossary",id:"glossary",level:2},{value:"Overview",id:"overview",level:2},{value:"Service to service calls",id:"service-to-service-calls",level:2},{value:"Auth patterns",id:"auth-patterns",level:2},{value:"Role-Based Access",id:"role-based-access",level:3},{value:"Permission-Based Access",id:"permission-based-access",level:3},{value:"Tokens",id:"tokens",level:2},{value:"Decoding a token",id:"decoding-a-token",level:3},{value:"Token structure",id:"token-structure",level:3},{value:"Roles",id:"roles",level:2},{value:"Roles without permissions",id:"roles-without-permissions",level:3},{value:"Roles containing dynamic data",id:"roles-containing-dynamic-data",level:3},{value:"Owning roles vs. having roles",id:"owning-roles-vs-having-roles",level:3},{value:"Conventions",id:"conventions",level:3},{value:"Organizations",id:"organizations",level:2},{value:"Access rules",id:"access-rules",level:3},{value:"Create",id:"create",level:4},{value:"Membership",id:"membership",level:4},{value:"Use cases",id:"use-cases",level:3},{value:"Permissions",id:"permissions",level:2},{value:"Conventions",id:"conventions-1",level:3},{value:"Services with multiple nodes",id:"services-with-multiple-nodes",level:2}];function d(e){const s={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(s.header,{children:(0,r.jsx)(s.h1,{id:"user-svc",children:"User Svc"})}),"\n",(0,r.jsxs)(s.p,{children:["The user service is at the heart of 1Backend, managing users, tokens, organizations, permissions and more. Each service and human on an 1Backend network has an account in the ",(0,r.jsx)(s.code,{children:"User Svc"}),"."]}),"\n",(0,r.jsxs)(s.blockquote,{children:["\n",(0,r.jsxs)(s.p,{children:["This page provides a high-level overview of ",(0,r.jsx)(s.code,{children:"User Svc"}),". For detailed information, refer to the ",(0,r.jsx)(s.a,{href:"/docs/1backend/login",children:"User Svc API documentation"}),"."]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"glossary",children:"Glossary"}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Token"}),": A JWT (JSON Web Token) issued and signed by the User Svc, used to authenticate both human and service accounts."]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Role"}),": A simple string identifier like ",(0,r.jsx)(s.code,{children:"user-svc:user"})," or ",(0,r.jsx)(s.code,{children:"user-svc:org:{orgId}:admin"})," that represents a specific capability or access level. Roles are embedded in tokens."]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Enroll"}),": (Enrollment) A mechanism to assign roles to users\u2014both current and future. Enrolls allow roles to be claimed later, once the user joins or logs in."]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Permission"}),": A string such as ",(0,r.jsx)(s.code,{children:"petstore-svc:read"}),", typically mapping to an API action or endpoint. Roles can bundle multiple permissions."]}),"\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Permit"}),": A mechanism for assigning permissions to users or roles. Permits define who can access what by connecting users or roles with specific permissions."]}),"\n",(0,r.jsx)(s.h2,{id:"overview",children:"Overview"}),"\n",(0,r.jsx)(s.p,{children:"The most important thing about the User Svc is that service (machine) and user (human) accounts look and function the same."}),"\n",(0,r.jsxs)(s.p,{children:["Every service you write needs to ",(0,r.jsx)(s.a,{href:"/docs/1backend/register",children:"register"})," at startup, or ",(0,r.jsx)(s.a,{href:"/docs/1backend/login",children:"log in"})," with the credentials it saves and manages if it's already registered. Just like a human."]}),"\n",(0,r.jsx)(s.p,{children:"A service account is not an admin account, it's a simple user level account. You might wonder how service-to-service calls work then."}),"\n",(0,r.jsx)(s.h2,{id:"service-to-service-calls",children:"Service to service calls"}),"\n",(0,r.jsx)(s.p,{children:"Most endpoints on 1Backend can only be called by administrators by default."}),"\n",(0,r.jsxs)(s.p,{children:["Let's take prompting. If you want to let your users prompt AIs you might write a wrapper service called ",(0,r.jsx)(s.code,{children:"User Prompter Svc"})," with the slug ",(0,r.jsx)(s.code,{children:"user-prompter-svc"}),"."]}),"\n",(0,r.jsxs)(s.p,{children:["If we look at the ",(0,r.jsx)(s.a,{href:"/docs/1backend/prompt",children:"Add Prompt endpoint API docs"}),", we can see that it mentions"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{children:"Requires the `prompt-svc:prompt:create` permission.\n"})}),"\n",(0,r.jsx)(s.p,{children:"To enable your service to call the Add Prompt endpoint, we need to create a permit with your service slug and the permission mentioned above:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-yaml",children:'id: "user-prompter-permit"\npermissionId: "prompt-svc:prompt:create"\nslugs:\n  - "user-prompter-svc"\n'})}),"\n",(0,r.jsxs)(s.p,{children:["You can apply these permits with an administrator account in your CI workflow with the ",(0,r.jsx)(s.code,{children:"oo"})," CLI:"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-sh",children:"oo permit save user-prompter-permit.yaml\n"})}),"\n",(0,r.jsx)(s.h2,{id:"auth-patterns",children:"Auth patterns"}),"\n",(0,r.jsx)(s.h3,{id:"role-based-access",children:"Role-Based Access"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:[(0,r.jsx)(s.strong,{children:"Role-Only Checks"}),": Authorize users based solely on their assigned roles. This is the simplest method\u2014no need to check individual permissions."]}),"\n"]}),"\n",(0,r.jsx)(s.h3,{id:"permission-based-access",children:"Permission-Based Access"}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"API Permission Check"}),": Use the ",(0,r.jsx)(s.code,{children:"Has Permission"})," endpoint with the user's authentication headers and a permission ID to verify access dynamically."]}),"\n"]}),"\n",(0,r.jsxs)(s.li,{children:["\n",(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.strong,{children:"Cached Role Permissions"}),": Store ",(0,r.jsx)(s.code,{children:"Permit"}),"s locally and check only the user's token for the required role. This is faster and avoids API calls but requires a bit more setup."]}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsx)(s.li,{children:"An SDK can help simplify this."}),"\n",(0,r.jsxs)(s.li,{children:["If you need to verify a token manually, refer to the ",(0,r.jsx)(s.code,{children:"Get Public Key"})," endpoint."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(s.blockquote,{children:["\n",(0,r.jsxs)(s.p,{children:["If you are looking at restricting access to endpoints in other ways, you might be interested in: ",(0,r.jsx)(s.a,{href:"/docs/built-in-services/policy-svc",children:"Policy Svc"}),"."]}),"\n"]}),"\n",(0,r.jsx)(s.h2,{id:"tokens",children:"Tokens"}),"\n",(0,r.jsxs)(s.p,{children:["The User Svc produces a JWT (",(0,r.jsx)(s.a,{href:"https://en.wikipedia.org/wiki/JSON_Web_Token",children:"JSON Web Token"}),") upon ",(0,r.jsx)(s.a,{href:"/docs/1backend/login",children:"/user-svc/login"})," in the ",(0,r.jsx)(s.code,{children:"token.token"})," field (see the response documentation)."]}),"\n",(0,r.jsxs)(s.p,{children:["You can either use this token as a proper JWT - decode it and inspect the contents, or you can just use the token to read the user account that belongs to the token with the ",(0,r.jsx)(s.a,{href:"/docs/1backend/read-user-by-token",children:"/user-svc/user/by-token"})," endpoint."]}),"\n",(0,r.jsx)(s.h3,{id:"decoding-a-token",children:"Decoding a token"}),"\n",(0,r.jsxs)(s.p,{children:["The ",(0,r.jsx)(s.a,{href:"/docs/1backend/get-public-key",children:(0,r.jsx)(s.code,{children:"/user-svc/public-key"})})," will return you the public key of the User Svc which then you can use that to decode the token."]}),"\n",(0,r.jsxs)(s.p,{children:["Use the JWT libraries that are available in your programming language to do that, or use the Singularon ",(0,r.jsx)(s.a,{href:"https://github.com/1backend/1backend/tree/main/sdk",children:"SDK"})," if your language is supported."]}),"\n",(0,r.jsx)(s.h3,{id:"token-structure",children:"Token structure"}),"\n",(0,r.jsx)(s.p,{children:"The structure of the JWT is the following:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-yaml",children:"# User Id\noui: usr_dC4K75Cbp6\n\n# Slug\nolu: test-user-slug-0\n\n# Roles\noro:\n  - user-svc:user\n  - user-svc:org:{org_dC4K7NNDCG}:user\n"})}),"\n",(0,r.jsx)(s.p,{children:"The field names are kept short to save space, so perhaps the Go definition is also educational:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-go",children:'type Claims struct {\n\tUserId  string   `json:"oui"` // `oui`: 1backend user ids\n\tSlug    string   `json:"osl"` // `osl`: 1backend slug\n\tRoles []string   `json:"oro"` // `oro`: 1backend roles\n\tjwt.RegisteredClaims\n}\n'})}),"\n",(0,r.jsx)(s.h2,{id:"roles",children:"Roles"}),"\n",(0,r.jsxs)(s.p,{children:["Roles are simply strings. They are not a database record, they don't have an ID, name etc. They are simple strings, such as ",(0,r.jsx)(s.code,{children:"user-svc:admin"}),"."]}),"\n",(0,r.jsx)(s.p,{children:"A user token produced upon login contains all the roles a user has."}),"\n",(0,r.jsxs)(s.blockquote,{children:["\n",(0,r.jsx)(s.p,{children:"Efficiency Tip: JWT tokens are sent with every request. Keeping the number of roles minimal improves performance."}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:"When checking if a user is authorized, there are a few common patterns to choose from:"}),"\n",(0,r.jsx)(s.h3,{id:"roles-without-permissions",children:"Roles without permissions"}),"\n",(0,r.jsx)(s.p,{children:"Roles are powerful, even without specific permissions attached. One common use case is managing product subscriptions."}),"\n",(0,r.jsx)(s.p,{children:"Suppose you launch a new product called Funny Cats Newsletter with two subscription tiers: Pro and Ultra. You could create a service with the slug funny-cats-newsletter-svc and define custom static roles for each tier:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-yaml",children:"funny-cats-newsletter-svc:pro\nfunny-cats-newsletter-svc:ultra\n"})}),"\n",(0,r.jsx)(s.p,{children:"By checking if these roles exist in a user's token, you can authorize access to product-specific features. These roles can be created dynamically by calling the Create Role endpoint."}),"\n",(0,r.jsx)(s.h3,{id:"roles-containing-dynamic-data",children:"Roles containing dynamic data"}),"\n",(0,r.jsx)(s.p,{children:"You are free to make up your own roles which might even have dynamic data, just like the User Svc did with the organization ids."}),"\n",(0,r.jsx)(s.p,{children:"Example:"}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-sh",children:"user-svc:org:{org_dBZRCej3fo}:admin\nuser-svc:org:{org_dBZRCej3fo}:user\n"})}),"\n",(0,r.jsxs)(s.p,{children:["By convention these dynamic values are enclosed in ",". In this example, roles are assigned per organization. For more details, see the Organizations section."]}),"\n",(0,r.jsx)(s.h3,{id:"owning-roles-vs-having-roles",children:"Owning roles vs. having roles"}),"\n",(0,r.jsxs)(s.p,{children:["In many endpoints such ",(0,r.jsx)(s.code,{children:"SaveEnrolls"}),', the topic of "role ownership" comes up. The basic problem is simple: just because someone has a role, it doesn\'t mean they can also bestow that role upon other users. In simple terms, if an admin makes someone a user, that user should not be able to make others users, as that is the privilege of the admins.']}),"\n",(0,r.jsx)(s.p,{children:'A user "owns" a role in the following cases:'}),"\n",(0,r.jsxs)(s.ul,{children:["\n",(0,r.jsxs)(s.li,{children:["The role is prefixed with the caller's slug. For example, a user with the slug ",(0,r.jsx)(s.code,{children:"joe-doe"})," owns roles like ",(0,r.jsx)(s.code,{children:"joe-doe:any-custom-role"}),"."]}),"\n",(0,r.jsxs)(s.li,{children:['User "owns" all roles that share a prefix if they hold the corresponding ',(0,r.jsx)(s.code,{children:":admin"})," role. For example, having ",(0,r.jsx)(s.code,{children:"user-svc:org:{org_id}:admin"})," means the user owns roles like ",(0,r.jsx)(s.code,{children:"user-svc:org:{org_id}:user"})," and ",(0,r.jsx)(s.code,{children:"user-svc:org:{org_id}:viewer"}),"."]}),"\n"]}),"\n",(0,r.jsx)(s.p,{children:"By enforcing role ownership rules, the system ensures that roles are only assigned by authorized users, preventing privilege escalation and maintaining security within the organization."}),"\n",(0,r.jsx)(s.h3,{id:"conventions",children:"Conventions"}),"\n",(0,r.jsx)(s.p,{children:"Each role created must by prefixed by the slug of the account that created it. Said account becomes the owner of the role and only that account can edit the role."}),"\n",(0,r.jsx)(s.h2,{id:"organizations",children:"Organizations"}),"\n",(0,r.jsx)(s.p,{children:"In the dynamic roles section we already talked about organizations, lets elaborate on them here a bit."}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-yaml",children:'id: "org_eZqC0BbdG2"\nname: "Acme Corporation" # Full name of the organization\nslug: "acme-corporation" # URL-friendly unique identifier for the organization\ncreatedAt: "2025-01-15T12:00:00Z" # Example ISO 8601 timestamp\n'})}),"\n",(0,r.jsx)(s.h3,{id:"access-rules",children:"Access rules"}),"\n",(0,r.jsx)(s.h4,{id:"create",children:"Create"}),"\n",(0,r.jsxs)(s.p,{children:["Any logged in user can create an organization, provided the ",(0,r.jsx)(s.code,{children:"Organization"})," slug is not taken yet. The creator becomes the first admin of the organization, acquiring the role of ",(0,r.jsx)(s.code,{children:"user-svc:org:{orgId}:admin"})," role."]}),"\n",(0,r.jsx)(s.h4,{id:"membership",children:"Membership"}),"\n",(0,r.jsxs)(s.p,{children:["Admins can assign other users member (",(0,r.jsx)(s.code,{children:"user-svc:org:{orgId}:user"}),") or admin roles (",(0,r.jsx)(s.code,{children:"user-svc:org:{orgId}:admin"}),") for the organizations they administer."]}),"\n",(0,r.jsx)(s.h3,{id:"use-cases",children:"Use cases"}),"\n",(0,r.jsx)(s.p,{children:"Organizations let users to freely associate with each other and create groups. Think about Discord servers, Slack workspaces, Github organizations etc."}),"\n",(0,r.jsx)(s.h2,{id:"permissions",children:"Permissions"}),"\n",(0,r.jsx)(s.h3,{id:"conventions-1",children:"Conventions"}),"\n",(0,r.jsx)(s.p,{children:"Each permission created must by prefixed by the slug of the account that created it. Said account becomes the owner of the permission and only that account can add the permission to a role."}),"\n",(0,r.jsxs)(s.blockquote,{children:["\n",(0,r.jsx)(s.p,{children:"Once you (your service) own a permission (by creating it, and it being prefixed by your account slug), you can add it to any role, not just roles owned by you."}),"\n"]}),"\n",(0,r.jsxs)(s.p,{children:["Example; let's say your service is ",(0,r.jsx)(s.code,{children:"petstore-svc"}),". 1Backend prefers fine-grained access control, so you are free to define your own permissions, such as ",(0,r.jsx)(s.code,{children:"petstore-svc:read"})," or ",(0,r.jsx)(s.code,{children:"petstore-svc:pet:read"}),"."]}),"\n",(0,r.jsx)(s.h2,{id:"services-with-multiple-nodes",children:"Services with multiple nodes"}),"\n",(0,r.jsxs)(s.p,{children:['You might now wonder what happens when a service has multiple instances/nodes. Won\'t their user accounts "clash" in the ',(0,r.jsx)(s.code,{children:"User Svc"}),"? The answer to this is that from the ",(0,r.jsx)(s.code,{children:"User Svc"})," point of view, each node/instance of a service is the same account."]}),"\n",(0,r.jsx)(s.p,{children:'This is possible because the platform is designed with services having a "Shared Database Access".'}),"\n",(0,r.jsxs)(s.p,{children:["Let's say you have a Cassandra network that spans multiple Availability Zones/Regions. Your nodes will also span multiple AZs/Regions and each instance of them will log in as ",(0,r.jsx)(s.code,{children:"X Svc"}),"."]})]})}function h(e={}){const{wrapper:s}={...(0,o.R)(),...e.components};return s?(0,r.jsx)(s,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},28453:(e,s,n)=>{n.d(s,{R:()=>t,x:()=>a});var i=n(96540);const r={},o=i.createContext(r);function t(e){const s=i.useContext(o);return i.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function a(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:t(e.components),i.createElement(o.Provider,{value:s},e.children)}}}]);